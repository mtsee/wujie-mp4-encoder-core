importScripts("mp4box.all.js");class MP4FileSink{#t=null;#e=null;#i=0;constructor(t,e){this.#e=t,this.#t=e}write(t){const e=new ArrayBuffer(t.byteLength);new Uint8Array(e).set(t),e.fileStart=this.#i,this.#i+=e.byteLength,this.#t("fetch",(this.#i/1048576).toFixed(1)+" MiB"),this.#e.appendBuffer(e)}close(){this.#t("fetch","Done"),this.#e.flush()}}class MP4Demuxer{#s=null;#o=null;#t=null;#e=null;get file(){return this.#e}constructor(t,{onConfig:e,onChunk:i,setStatus:s}){this.#s=e,this.#o=i,this.#t=s,this.#e=MP4Box.createFile(),this.#e.onError=t=>s("demux",t),this.#e.onReady=this.#n.bind(this),this.#e.onSamples=this.#a.bind(this);const o=new MP4FileSink(this.#e,s);fetch(t).then((t=>{t.body.pipeTo(new WritableStream(o,{highWaterMark:2}))}))}#r(t){const e=this.#e.getTrackById(t.id);for(const t of e.mdia.minf.stbl.stsd.entries)if(t.avcC||t.hvcC){const e=new DataStream(void 0,0,DataStream.BIG_ENDIAN);return t.avcC?t.avcC.write(e):t.hvcC.write(e),new Uint8Array(e.buffer,8)}throw"avcC or hvcC not found"}#h=null;set track(t){this.#h=t}get track(){return this.#h}#n(t){this.#t("demux","Ready");const e=t.videoTracks[0],i=t.tracks.find((t=>"audio"===t.type));if(!e)return console.warn("编码格式不支持前端解码"),void this.#s({error:!0,hasAudio:i});this.#s({codec:e.codec,codedHeight:e.video.height,codedWidth:e.video.width,nb_samples:e.nb_samples,volume:e.volume,hasAudio:i,movie_timescale:e.movie_timescale,movie_duration:e.movie_duration,description:this.#r(e)}),this.#e.setExtractionOptions(e.id),this.#e.start()}#a(t,e,i){for(const t of i)this.#o(new EncodedVideoChunk({type:t.is_sync?"key":"delta",timestamp:1e6*t.cts/t.timescale,duration:1e6*t.duration/t.timescale,data:t.data}))}}